<html><head><link rel="import" href="../polymer/polymer.html"></head><body><dom-module id="array-filter"><script>Polymer({is:"array-filter",properties:{items:{type:Array,notify:!0},filtered:{type:Array,notify:!0},observe:{type:String},filter:{type:Function,observer:"_filterChanged"},sort:{type:Function,observer:"_sortChanged"}},observers:["_itemsChanged(items.*)"],_sortChanged:function(e){var t=this.domHost,i=e;i?"function"!=typeof e&&(i=function(){return t[e].apply(t,arguments)}):i=void 0,this._sortFn=i,this.items&&this._debounceFilter()},_debounceFilter:function(){this.debounce("_filter",this._filter)},_filterChanged:function(e){var t=this.domHost,i=e;i?"function"!=typeof i&&(i=function(){return t[e].apply(t,arguments)}):i=void 0,this._filterFn=i,this.items&&this._debounceFilter()},_itemsChanged:function(e){var t=e.path;"items"===t?this._debounceFilter():"items.length"===t||("items.splices"===t?this._computeSplices(e.value.keySplices,e.value.indexSplices):this._checkSort(e.path))},_resetLinks:function(){if(this.filtered)for(var e,t,i=Polymer.Collection.get(this.filtered),s=Polymer.Collection.get(this.items),r=0;r<this.filtered.length;r++)e=this.filtered[r],t=i.getKey(e),this.unlinkPaths("filtered."+t),this.linkPaths("filtered."+t,"items."+s.getKey(e))},_filter:function(){this.filtered=this._computeFiltered(this.items),this._resetLinks()},update:function(){this._debounceFilter()},_computeFiltered:function(e){if(e){var t=e.slice(0);return this._filterFn&&(t=t.filter(this._filterFn)),this._sortFn&&(t=t.sort(this._sortFn)),t}},_computeSplices:function(e,t){t.forEach(function(e){var t,i=this._computeFiltered(e.object),s=[];e.removed.forEach(function(e){this.arrayDelete("filtered",e)}.bind(this));for(var r=0;r<e.addedCount;r++)t=e.object[e.index+r],i.indexOf(t)!==-1&&s.push([t,i.indexOf(t)]);s.sort(function(e,t){return e[1]-t[1]}).forEach(function(e){this.splice("filtered",e[1],0,e[0])}.bind(this))}.bind(this)),this._resetLinks()},_applyObserver:function(e){var t=e.split("."),i=this._computeFiltered(this.items),s=Polymer.Collection.get(this.filtered),r=Polymer.Collection.get(this.items),n=r.getItem(t[1]),o=this.filtered.indexOf(n),l=i.indexOf(n);if(o!==l){if(o!==-1){var h=s.getKey(n);this.unlinkPaths("filtered."+h),this.arrayDelete("filtered",n)}l!==-1&&this.splice("filtered",l,0,n)}this._resetLinks()},_checkSort:function(e){var t=e.split(".");t[1];if(this.observe&&(this.sort||this.filter))if(t.length<=2)this._debounceFilter();else{var i=t.slice(2).join("."),s=this.observe.split(" "),r=s.some(function(e){return i===e||0===i.indexOf(e+".")||0===e.indexOf(i+".")});r&&this._applyObserver(e)}}});</script></dom-module></body></html>